<!DOCTYPE html>
<html>
  <head>
    <title>26 Shader Variant Prefiltering</title>
    <meta charset="utf-8">
    <style>
      .remark-slide-content {
        color: white;
        background-color: black;
        font-size: 50pt;
        padding: 0px 0.5em;
      }
      .remark-code-line { font-size: 19pt; margin: 0.2em 0px; }
      p { margin: 0.5em 0px; line-height: 120%; }
      code { margin: 0px 2em; }
    </style>
  </head>
  <body>
<textarea id="source">

みなさんこんにちは。

今回はトピックは、 Unity のビルド時間が短くなる、 Shader Variant Prefiltering です。

---

今回の話はちょっと複雑なんですが、先に結論を言っておきますね。

Unity を最新版にアップデートすると、プロジェクトのビルド時間が劇的に速くなる……かもしれない、というお話です。

---

この改良は 2021 LTS と 2022, 2023 Tech Stream の全てに追加されたので、多くの人に関係のある話になってくると思います。

---

例えば、この URP Terrain Demo プロジェクトでは、クリーンビルド時間……つまりプロジェクトの初回のビルドですね、それが 45 分から 18 分に短縮された、となっています。

半分以下になっていますよね。

かなりの高速化です。

---

さてそれでは、一体どこが速くなったのか、なぜ速くなったのか、順に解説していきたいと思います。

まず、どこが速くなったのかですが、簡単に言うと、シェーダーの数が少なくなることによってビルド時間が短くなります。

---

というのも、 Unity のプロジェクトってある程度の規模になると、シェーダーバリアントの増加によってビルド時間が長くなってしまうことが非常に多いんですよね。

---

これはお馴染み Boat Attack プロジェクトですが、手元の PC でクリーンビルドしたところ、初回のビルドに 25 分かかりました。

だいぶ長いですね。

---

でもこれを詳しく見てみると、そのうち 20 分以上がシェーダーの処理にかけられているんですよね。

シェーダーバリアントがビルド時間のボトルネックになっているという状態です。

---

ただし、このように時間がかかるのは Clean Build 、要するに初回のビルドだけで、２回目以降のビルド、いわゆる Warm Build はもっと早く終わります。

この PC の場合は１分半ぐらいでウォームビルドできます。

---

ここまでの話を一旦まとめると、クリーンビルドは非常に時間がかかる、その理由はシェーダーバリアントにある、ということでした。

---

シェーダーバリアントっていうのは、条件コンパイルを使うことで、オプションの異なるシェーダーを複数生成することです。

---

プログラマ以外の方にも分かるよう簡単に説明してみます。

ここに例として作ったスプライト用のシェーダーグラフがあります。

---

スプライトの周りにアウトラインを表示する機能を実装しました。

これを on/off できるようにスイッチを用意したんですけど、こういう条件分岐って GPU はとても苦手とする処理なんですよね。

---

それに、アウトラインを使っていない時にも、アウトライン処理の入ったシェーダーがロード・実行されているというのは、色々デメリットがあります。

そんな時に役立つのが、このキーワードという機能です。

---

これがオンになっている状態のシェーダーと、オフになっている状態のシェーダーと、２つのシェーダーを生成して、適切なシェーダーを自動的に選んでくれるようになります。

これがいわゆるシェーダーバリアントですね。

---

シェーダーバリアントを使うことで、動的な条件分岐ではなく、シェーダーの入れ替えによって機能の切り替えができるようになります。

---

また、使用している機能だけに絞って最適化されたシェーダーが使われるため、パフォーマンス面でもメリットがあります。

---

このようなシェーダーバリアントは、実はレンダーパイプラインの各所で暗黙に作られています。

---

例えば、ライトの個数に応じてバリアントを作ったり、ライトマップの on/off でバリアントを作ったり、シャドウマップのためにバリアントを作ったり……などなど。

---

シェーダーバリアントは合理的な手法ですが、欠点もあります。

それは、バリアントの数が容易に増えてしまうということです。

---

例えば、調子に乗って６個もキーワードを使ったシェーダーを用意してみました。

---

すると、１個目のキーワードの on/off で２通りのバリアント、２個目のキーワードの on/off と合わせて４通りのバリアント、８通り、１６通り……と倍々に増えていって、この中だけでも６４通りのバリアントが生まれることになります。

---

実際にはここから更にレンダーパイプライン側がバリアントを生成することになりますから、もっともっと増えるはずです。

---

インスペクタで調べてみたら 4,600 個ぐらいのバリアントが生まれることになるみたいですね。

これは多いですよねえ。

---

このプロジェクトをクリーンビルドしてみたところ、４分以上かかりました。

たった１個シェーダーを置いただけのプロジェクトで、４分です。

---

シェーダーバリアントの恐ろしさが分かっていただけたと思いますが、いよいよここからが本題です。

---

最新版の Unity では、このバリアントの生成を減らすための処理が追加されました。

それが Shader Variant Prefiltering です。

---

今まではシェーダーバリアントを生成した後に、不要なバリアントを除外するというストリップ処理が行われていました。

---

でも、ここまでの説明からも分かる通り、もうバリアントを生成するだけでも大変な処理量になってしまうんですよね。

---

そこで、現状のレンダーパイプラインの設定を参考にして、必要の無いバリアントはそもそも生成しない、生成する前に除外する、という prefiltering 処理が行われるようになりました。

---

これによってビルドにかかる時間が大幅に減る可能性があります。

例えば先ほどのシェーダー１個で４分かかったプロジェクトは、プレフィルタリングによって約半分にまで短縮されました。

---

ちなみにこのプレフィルタリング処理は、今の所 URP でのみ使用されています。

将来的には HDRP でも効果が得られるといいですよね。

今後のバージョンアップに期待したいところです。

---

こんな感じで今回は Shader Variant Prefiltering について解説してきましたが、いかがでしたでしょうか？

---

ちょっと遠回りな説明になってしまいましたが、まあね、シェーダーバリアントの恐ろしさを皆さんに知っていただけたらと思い、ついでに色々話してみました。

---

今回の動画が参考になったという方は高評価やコメントを頂けると有難いです。

それではまた次回の動画でお会いしましょう。

</textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        ratio: '16:9',
        highlightStyle: 'sunburst',
        slideNumberFormat: ''
      });
    </script>
  </body>
</html>
