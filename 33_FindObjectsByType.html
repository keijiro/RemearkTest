<!DOCTYPE html>
<html>
  <head>
    <title>33 FindObjectsByType</title>
    <meta charset="utf-8">
    <style>
      .remark-slide-content {
        color: white;
        background-color: black;
        font-size: 50pt;
        padding: 0px 0.5em;
      }
      .remark-code-line { font-size: 19pt; margin: 0.2em 0px; }
      p { margin: 0.5em 0px; line-height: 120%; }
      code { margin: 0px 2em; }
    </style>
  </head>
  <body>
<textarea id="source">

Unity の API の一つに FindObjectsOfType というのがあります。

これは指定された型のオブジェクトを単純に列挙するというものです。

例えば FindObjectsOfType BoxCollider などとすれば、シーン中の Box Collider を全て列挙することができるということですね。

ただ、このメソッドは、恐らく皆さんご想像の通り、かなり負荷が高いです。

なので、開発チームによっては、このメソッドを使用禁止にしていることも多いんじゃないでしょうか。

僕もこのメソッドは、使用を避けられるなら避けた方がいいと思うんですけどね。

ただ、アプリケーション側のコードではなく、汎用的なライブラリやパッケージのコードでは、どうしてもこれを使わざるを得ないというケースがあると思います。

で、今回のお話は、その FindObjectsOfType が最近のバージョンの Unity で高速化されたという話です。

ただ、高速化にあたって、挙動が若干変化するため、既存の実装を置き換えのではなく、新しいメソッドを追加することにしました。

それが FindObjectsByType です。

FindObjectsByType には sort mode を引数として渡すことができます。

Sort mode を InstanceID にすれば、得られる結果は InstanceID 順でソートされたものとなります。

これは従来の FindObjectsOfType と同じ挙動ですね。

結果をソートする必要が無い場合は None を渡してください。

ソート処理が省略されるため、動作の高速化が期待できます。

ここで、おやっ？と思った人もいるかもしれませんが、そうなんです、従来の FindObjectsOfType は、結果を Instance ID でソートしていたんですね。

これ、マニュアルにも書かれていない挙動なんですが、検索結果の一貫性を保つために、Instance ID を使ったソートというのが行われていました。

そのために挙動が重くなってしまっていたケースも、かなりあると思います。

Undocumented な仕様なので、単純に従来の実装からソート処理を削除して高速化する案もあったんですが、安全性を考慮して、別のメソッドとして提供することになりました。

さて、この高速化によって、どの程度処理が速くなるか、皆さん気になりますよね。

簡単なベンチマークで計測してみたんですが、このベンチマークでは、検索結果の個数にかかわらず、全体的に 40% ぐらい速くなっている、という感じでしょうか。

ただこの結果は、あんまりあてにならないですね。

従来の実装が検索結果のソート処理によって重くなっているとすれば、検索結果の個数によって変動しないというのは、ちょっとおかしい気がします。

このソート処理の負荷はシーンの構築方法によって異なってくるというのが実際のところのようです。

このソート処理の削除によって 95% 短縮されたという報告もありますから、ケース・バイ・ケースで効果が異なってくるということなのでしょう。

とりあえず、この高速化によって逆に遅くなるということは無いはずですので、まあどの程度の効果があるかはさておき、ひとまず入れ替えてみるというのが良いと思います。

---

ここまで紹介してきた FindObjectsByType は、複数のオブジェクトを列挙するメソッドですが、この他に、単一のオブジェクトを返すメソッドもあります。

ひとつは FindFirstObjectByType で、もうひとつは FindAnyObjectByType です。

FindFirstObjectByType は、従来の FindObjectOfType と互換性のあるメソッドですね。

InstanceID の一番若いオブジェクトを返します。

これに対して、FindAnyObjectByType は、今回の高速化によって増えたバージョンです。

InstanceID を考慮せず、とにかく最初に見つけたオブジェクトを返します。

まあ当然、こちらの方が動作としては速いわけですね。

---

今回紹介した FIndObjectsByType は、現状サポートしている Unity の全バージョンで追加されました。

具体的には、Unity 2020.3.4 と 2021.3.18 と 2022.2.5 です。

これから出る 2022.3 LTS も含めて、すべての LTS で使用できるようになっているということですね。

ですので、最新版で開発しているプロジェクトだけでなく、LTS 上で開発しているプロジェクトでも移行を検討することができます。

2023.1.0 では、古い FindObjectsOfType の方は Deprecated 指定になって、使用時に警告が出るようになっています。

今の段階では、なるべく新しいメソッドに入れ替えてくださいねー、という警告ですが、いずれエラー指定になって、しばらくしたら実装自体が無くなる予定です。

なので、今後はなるべく FindObjectsByType を使うようにしてください。

</textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        ratio: '16:9',
        highlightStyle: 'sunburst',
        slideNumberFormat: ''
      });
    </script>
  </body>
</html>
