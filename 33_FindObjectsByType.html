<!DOCTYPE html>
<html>
  <head>
    <title>33 FindObjectsByType</title>
    <meta charset="utf-8">
    <style>
      .remark-slide-content {
        color: white;
        background-color: black;
        font-size: 50pt;
        padding: 0px 0.5em;
      }
      .remark-code-line { font-size: 25pt; margin: 0.2em 0px; }
      p { margin: 0.5em 0px; line-height: 120%; }
      code { margin: 0px 2em; }
    </style>
  </head>
  <body>
<textarea id="source">

> Camera

Unity の API の一つに FindObjectsOfType というのがあります。

これは指定された型のオブジェクトを列挙するというメソッドです。

---
class: middle

```CSharp
var boxes = FindObjectsOfType<BoxCollider>();
```

---

例えば "FindObjectsOfType BoxCollider" などとすれば、シーン中の BoxCollider を全て列挙することができます。

---

> Camera

ただ、このメソッドは、恐らく皆さんご想像の通り、かなり負荷が高いです。

---

開発現場によっては、このメソッドを使用禁止にしている場合もあるんじゃないでしょうか。

---

そんな「Unity における重たい関数」の代表格でもある FindObjectsOfType なんですが、なんと、最近のバージョンの Unity において、これの高速化が行われました。

---

ただ、高速化にあたって挙動が若干変化するため、既存の実装を置き換えるのではなく、新しいメソッドを追加することになりました。

---
class: middle

```CSharp
FindObjectsByType<T>(sortMode)
```
---

それが FindObjectsByType です。

名前がほんのちょっと変更されていますね。

"Of Type" が "By Type" になっています。

---

また、引数として sortMode が追加されています。

---
class: middle

```CSharp
FindObjectsByType<T>(FindObjectsSortMode.None);

FindObjectsByType<T>(FindObjectsSortMode.InstanceID);
```
---

SortMode には２種類のオプションが用意されています。

None と InstanceID です。

---
class: middle

```CSharp
FindObjectsByType<T>(FindObjectsSortMode.InstanceID);
```
---

InstanceID を使うと、検索結果は Instance ID を使ってソートされたものになります。

従来の FindObjectOfType と同じ結果を得たい場合は、SortMode InstanceID を使うようにしてください。

---
class: middle

```CSharp
FindObjectsByType<T>(FindObjectsSortMode.None);
```
---

None の場合はソートは行われず、返される配列の順序は不定になります。

InstanceID の場合と比較すると、ソート処理が省略されるので、動作の高速化が期待できますね。

---

> Camera

さて、ここまでの説明で、おやっ？と思った人もいるかもしれません。

---

そうなんです、従来の FindObjectsOfType は、結果をわざわざ Instance ID でソートしていたんですね。

---

> B-roll: Old manual

これ、マニュアルにも書かれていない挙動なんですが、検索結果の一貫性を保つために、Instance ID を使ったソートというのが行われていました。

---

このソート処理のために挙動が重くなってしまっていたというケースも、実はかなりあったと思います。

---

> B-roll: New manual

Undocumented な仕様なので、単純に従来の実装からソート処理を削除して高速化する、っていう案もあったんですが、安全性を考慮して、別のメソッドとして提供することになりました。

---

> Screenshot: Benchmark

さて、この高速化によって、どの程度処理が速くなるのか、皆さん気になりますよね。

---

簡単なベンチマークで計測してみたんですが、このベンチマークでは、検索結果の個数にかかわらず、全体的に 40% ぐらい速くなっている、という感じでしょうか。

---

ただまあ、検索結果の個数によって負荷が変わらない、というのはちょっとおかしい気もしますね。

単純なテストケースだと、ソート処理に負荷がかからないので、こんな感じになってしまうようです。

---

> Camera

ここまで紹介してきた FindObjectsByType は、対象となる全てのオブジェクトを列挙するメソッドですが、この他に、単一のオブジェクトを返すメソッドもあります。

---
class: middle

```CSharp
FindFirstObjectByType<T>()

FindAnyObjectByType<T>()
```
---

ひとつは FindFirstObjectByType で、もうひとつは FindAnyObjectByType です。

---

> B-roll: Manual

FindFirstObjectByType は、従来の FindObjectOfType と互換性のあるメソッドですね。

InstanceID の一番若いオブジェクトを返します。

---

これも undocumented な仕様なんですが、そういう挙動になっていたんですね。

当然、ソートの負荷も発生していました。

---

> B-roll: Manual

これに対して、FindAnyObjectByType は、今回の高速化によって増えたバージョンです。

ソート処理を行わず、とにかく最初に見つけたオブジェクトを返します。

---

まあ当然、こちらの方が動作としては速いわけですね。

---

> Camera

ということで、FindAnyObjectByType で済む場合は、なるべくこちらを使うことをお勧めします。

---

最後にこの機能が使用できるバージョンについてまとめたいと思います。

今回紹介した新 API は、現状サポートされている Unity の全バージョンに追加されています。

---

> Chart

具体的には、Unity 2020.3.4 と 2021.3.18 と 2022.2.5 の時点で追加されています。

---

これから出る 2022.3 LTS も含めて、すべての LTS で使用できるようになっているということですね。

---

> Camera

ですので、Tech Stream で開発しているプロジェクトだけでなく、LTS 上で開発しているプロジェクトでも移行を検討することができます。

---

> B-roll: Compilation warning

2023.1.0 では、古い FindObjectsOfType の方は Deprecated 指定になって、使用時に警告が出るようになっています。

---

なるべく新しいメソッドに入れ替えてくださいねー、という警告ですが、いずれエラー指定になって、しばらくしたら実装自体が無くなる予定です。

なので、今後は基本的に FindObjectsByType の方を使うようにしてください。









---

> Camera

ただこの結果は、ちょっとあんまりあてにならないですね。

---

> Screenshot: Benchmark

従来の実装が検索結果のソート処理によって重くなっているとすれば、検索結果の個数によって変動しないというのは、ちょっとおかしい気がします。

---

> Camera

このソート処理の負荷はシーンの構築方法によって異なってくるというのが実際のところのようです。

---

このソート処理の削除によって 95% 短縮されたという報告もありますから、ケース・バイ・ケースで効果が異なってくるということなのでしょう。

---

とりあえず、この高速化によって逆に遅くなるということは無いはずですので、まあどの程度の効果があるかはさておき、ひとまず入れ替えてみるというのが良いと思います。

---




---


</textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        ratio: '16:9',
        highlightStyle: 'sunburst',
        slideNumberFormat: ''
      });
    </script>
  </body>
</html>
