<!DOCTYPE html>
<html>
  <head>
    <title>23 Enter Play Mode</title>
    <meta charset="utf-8">
    <style>
      .remark-slide-content {
        color: white;
        background-color: black;
        font-size: 50pt;
        padding: 0px 0.5em;
      }
      .remark-code-line { font-size: 30pt; margin: 0.2em 0px; }
      p { margin: 0.5em 0px; line-height: 120%; }
      code { margin: 0px 2em; }
    </style>
  </head>
  <body>
<textarea id="source">

みなさんこんにちは。

今回のトピックは、使うだけで早くなる、Enter Play Mode オプションです。

---

Unity Editor には Enter Play Mode オプションというものが存在しています。

これをオンにすると、Play Mode に入る時間が早くなるというもので、基本的にはオンにして使うことをお勧めします。

---

実は今回、本当にお伝えしたかったことは以上なんですが、せっかくですので、この Enter Play Mode オプションで実際にどの程度速くなるのか、なぜ速くなるのか、副作用はあるのか、等々、少し掘り下げて話してみたいと思います。

---

まず、実際にどの程度速くなるのか検証してみましょう。

---

> Desktop

これはお馴染みの Boat Attack サンプルプロジェクトですが、Enter Play Mode オプションを使っていないと、Play Mode を開始するのに…

はい、４秒以上かかっていますね。

---

それでは、Enter Play Mode を有効にしてみましょう。

Edit の Project Settings から Editor を開いて…

この Enter Play Mode Options をオンにします。

---

これで Play Mode を開始すると…

はい、１秒もかかりませんでした。

かなり速くなってますね。

---

> Camera

このように Enter Play Mode オプションを使うことでテストプレイにかかる時間を短縮することができます。

---

これは常に有効にしておきたい機能ですよね。

さて、それでは、なぜ Enter Play Mode オプションを使うと速くなるんでしょうか？

---

> Desktop

もう一度 Enter Play Mode Options を見てみると…

この "Reload Domain" と "Reload Scene" の２つがオフになっているのが分かると思います。

---

このドメイン・リローディングと、シーン・リローディングの、２つのリローディング処理が省略されることによって、動作が高速化されている…

というのが、ここで起こっていることの実態です。

---

> Camera

ドメイン・リローディングというのは、簡単に言えば C# スクリプティング・システムの再起動です。

これはアプリ起動直後の状態を再現するために行われます。

---

> Overlay

再起動のために、まずはオブジェクトを一旦全部シリアライズします。

---

そしてシステムを再起動して、その後デシリアライズしてオブジェクトを復活させる、という流れになります。

この一連の処理はかなり重たいものになるので、一定時間待たされることになります。

---

> Desktop

ちなみに、このドメイン・リローディングはスクリプトをコンパイルした時にも発生していますね。

それと同じ負荷が Play Mode に入る時も発生している、という感じです。

---

> Camera

"Reload Domain" のオプションをオフにすると、このドメイン・リローディングを行わずに Play Mode が始まるようになります。

---

ドメイン・リローディングしなくても大丈夫なのかというと、まあ大丈夫じゃないケースもあるんですが、それについては後で触れましょう。

---

> Desktop

次のシーン・リローディングは、名前の通り、現在開いているシーンをリロードする処理ですね。

---

> Camera

これもやはり、アプリ起動直後の状態を再現するために行われます。

---

> Overlay

ビルドされたアプリでは、まずシーンをロードして、オブジェクトを初期化して、そして最初のフレームの処理を始めることになりますよね。

---

Editor 上でも同じように、シーンをロードして、初期化して、最初のフレーム…という順序にしたいので、わざわざ一旦シーンを破棄してからリロードしているわけです。

---

ただこれについては、本当にシーンをリロードしなくても、初期化処理だけ走らせれば、大体似た挙動になるような気がします。

---

この "Reload Scene" のオプションをオフにすると、そういう擬似的な処理で済ませて、実際のリロードは行わないようになります。

---

最後に Enter Play Mode オプションの副作用について触れておきましょう。

まずドメイン・リローディングをオフにした場合の副作用ですが、分かりやすいところでは、static フィールドの初期化が行われなくなるという問題があります。

---

class: middle

```csharp
class Monster : MonoBehaviour {
  static int spawnCount;
  void Start() => spawnCount++;
}
```

---

例えばこんな感じのコードがあったとします。

Start が走る度に spawnCount をインクリメントしてスポーン回数を計測しよう、って感じですね。

---

ただこれ、ドメイン・リローディングを無効化すると、static 変数の初期化が行われなくなります。

Play モードを一旦止めて再開した場合に、spawnCount がゼロにならずに、前の値が残って蓄積されてしまうことになります。

---

> Documentation

これを修正するにはどうしたらいいかと言うと…

---

ドキュメントでは RuntimeInitializeOnLoadMethod とかを使えばいいよ、と書いてあります。

たしかにこれで直せるんですが、解決法としてはちょっと凝り過ぎているかな、と言う気もします。

---

個人的には、そもそもこういった用途に static 変数を使うのを避けて、マネージャクラスのようなものを用意して管理する、というのがベターな解決方法かなと思います。

---

> Documentation

また、Unity 側で static 定義されているイベントハンドラなども同じく注意が必要です。

---

> Camera

一方、シーン・リローディングについては副作用が小さいので、問題になることはかなり少ないと思います。

---

ただ、ExecuteEditMode 属性などを使って、Edit Mode 中も動作するコンポーネントを実装した場合などに、その挙動が若干変化するので、ちょっと注意が必要かもしれません。

---

Edit Mode に対応したアセットを開発している場合は、ドキュメントをチェックしてみてください。

---

> Camera

また、副次的な問題として、皆さんが使用しているライブラリや、サードパーティーアセットが Enter Play Mode オプションに対応していない場合、問題が発生する可能性があります。

---

これについては、開発者に連絡して直してもらうしかないですね。

Enter Play Mode オプションは開発速度に大きく影響を与える要素ですので、これに対応するのはもはや必須と言っても過言ではないと思います。

---

もちろん、Unity 公式アセットが Enter Play Mode オプションで問題を起こしていた場合は、ぜひバグレポートを送ってください。

これは当然対応している機能ですので、うまく動かなかったとしたら明らかなバグです。

---

今回はこんな感じで Enter Play Mode オプションについてお話ししましたが、いかがでしたでしょうか？

---

既にこのオプションを使っている方も多いと思いますが、デフォルトでは有効化されていないので、始めたばかりの段階ではなかなか気付きにくいんですよね。

---

今回の動画が参考になったという方は高評価やコメントを頂けると有難いです。

それではまた次回の動画でお会いしましょう。

</textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        ratio: '16:9',
        highlightStyle: 'sunburst',
        slideNumberFormat: ''
      });
    </script>
  </body>
</html>
