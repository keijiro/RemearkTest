<!DOCTYPE html>
<html>
  <head>
    <title>23 Enter Play Mode</title>
    <meta charset="utf-8">
    <style>
      .remark-slide-content {
        color: white;
        background-color: black;
        font-size: 50pt;
        padding: 0px 0.5em;
      }
      .remark-code-line { font-size: 30pt; margin: 0.2em 0px; }
      p { margin: 0.5em 0px; line-height: 120%; }
      code { margin: 0px 2em; }
    </style>
  </head>
  <body>
<textarea id="source">

みなさんこんにちは。

今回のトピックは、使うだけで早くなる、Enter Play Mode オプションです。

---

Unity Editor には Enter Play Mode オプションというものが存在しています。

これをオンにすると、Play Mode に入る時間が早くなるというもので、基本的にはオンにして使うことをお勧めします。

---

実は今回、本当にお伝えしたかったことは以上なんですが、せっかくですので、この Enter Play Mode オプションで実際にどの程度速くなるのか、なぜ速くなるのか、副作用はあるのか、等々、少し掘り下げて話してみたいと思います。

---

まず、実際にどの程度速くなるのか試してみましょう。

---

> Desktop

これはお馴染みの Boat Attack サンプルプロジェクトですが、Enter Play Mode オプションを使っていない場合は、Play Mode を開始するのに…

はい、４秒以上かかっていますね。

---

それでは、Enter Play Mode オプションを有効にしてみましょう。

Project Settings から Editor を開いて…

この Enter Play Mode Options をオンにします。

---

これで Play Mode を開始すると…

はい、１秒もかかりませんでした。

かなり速くなってますよね。

---

> Camera

このように Enter Play Mode オプションを使うことでテストプレイにかかる時間を減らすことができます。

---

で、それじゃあなんで Enter Play Mode オプションを使うと速くなるんでしょうか？

---

> Desktop

もう一度 Enter Play Mode Options を見てみると…

この "Reload Domain" と "Reload Scene" の２つがオフになっているのが分かると思います。

---

このドメイン・リローディングと、シーン・リローディングの、２つのリローディング処理が省略されることによって、動作が高速化されている…

というのが、ここで起こっていることの実態です。

---

> Camera

ドメイン・リローディングというのは、簡単に言えば C# スクリプティング・システムの再起動です。

これはアプリ起動直後の状態を再現するために行われています。

---

> Overlay

スクリプティング・システムを再起動するために、まずはオブジェクトを一旦全部シリアライズします。

---

そしてシステムを再起動して、その後デシリアライズしてオブジェクトを復活させる、という流れになります。

この一連の処理はかなり重たいものになるので、一定時間待たされることになるんですね。

---

> Desktop

ちなみに、このドメイン・リローディングはスクリプトをコンパイルした時にも発生していますね。

それと同じ負荷が Play Mode に入る時にも発生している、という感じです。

---

> Camera

"Reload Domain" のオプションをオフにすると、このドメイン・リローディングを行わずに Play Mode が始まるようになります。

---

ドメイン・リローディングしなくても大丈夫なのかというと、まあ大丈夫じゃないケースもあるんですが、それは後で触れましょう。

---

> Desktop

次のシーン・リローディングは、名前の通り、現在開いているシーンをリロードする処理ですね。

---

> Camera

これもやっぱり、アプリ起動直後の状態を再現するために行われています。

---

> Overlay

ビルドされたアプリでは、まずシーンをロードして、オブジェクトを初期化して、そして最初のフレームの処理を始めることになりますよね。

---

Editor 上で Play Mode を始める時も同じようにしたいので、わざわざ一旦シーンを破棄してからリロードしているわけです。

---

ただこれについては、本当にシーンをリロードしなくても、初期化処理だけ走らせれば、大体似た挙動になるような気がします。

---

この "Reload Scene" のオプションをオフにすると、そういう擬似的な処理で済ませて、リロードまでは行わないようになるわけですね。

---

最後に Enter Play Mode オプションの副作用について触れておきます。

まずドメイン・リローディングをオフにした場合の副作用ですが、分かりやすいところでは、static フィールドの初期化が行われなくなるという問題があります。

---

class: middle

```csharp
class Monster : MonoBehaviour {
  static int spawnCount;
  void Start() => spawnCount++;
}
```

---

例えばこんな感じのコードがあったとします。

Start が走る度に spawnCount をインクリメントしてスポーン回数を計測しよう、って感じですね。

---

ただこれ、ドメイン・リローディングを無効化すると、static 変数の初期化が行われなくなります。

Play モードを一旦止めて再開した場合、spawnCount はゼロから始まらず、前回のプレイの値を引き継いでしまうことになります。

---

> Documentation

これを修正するにはどうしたらいいかと言うと…

ドキュメントでは RuntimeInitializeOnLoadMethod とかを使えばいいよ、と書いてありますね。

---

たしかにこれで直せるんですが、解決方法としてはちょっと回りくどいかな、と言う気もします。

---

個人的には、そもそもこういった用途に static 変数を使うのを避けて、マネージャクラスのようなものを用意して管理する、というのがベターな解決方法かなと思います。

---

> Camera

一方、シーン・リローディングについては副作用が小さいので、問題になることはかなり少ないと思います。

---

> Documentation

ただ、ExecuteInEditMode を使った場合なんかに、挙動が若干変化するので、注意が必要になります。

---

Edit Mode に対応したアセットを開発する場合は、ドキュメントを見て対処方法をチェックしてみてください。

---

> Camera

また、副次的な問題として、皆さんが使用しているサードパーティーアセットが Enter Play Mode オプションに対応していない場合、問題が発生する可能性があります。

---

これについては、まあアセット開発者に連絡して直してもらうしかないですよね。

Enter Play Mode オプションは開発効率に影響を与える要素なので、これに対応しておくのは必須と言っても過言ではないんじゃないかなと思います。

---

もちろん、Unity の標準アセットが Enter Play Mode オプションで問題を起こしていた場合は、ぜひバグレポートを送ってください。

---

今回はこんな感じで Enter Play Mode オプションについてお話ししましたが、いかがでしたでしょうか？

---

既にこのオプションを使っている方も多いと思いますが、デフォルトでは有効化されていないので、始めたばかりの段階では、なかなか気付きにくかったりすると思うんですよね。

---

今回の動画が参考になったという方は高評価やコメントを頂けると有難いです。

それではまた次回の動画でお会いしましょう。

</textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        ratio: '16:9',
        highlightStyle: 'sunburst',
        slideNumberFormat: ''
      });
    </script>
  </body>
</html>
