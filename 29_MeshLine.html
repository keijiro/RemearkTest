<!DOCTYPE html>
<html>
  <head>
    <title>29 Mesh Line</title>
    <meta charset="utf-8">
    <style>
      .remark-slide-content {
        color: white;
        background-color: black;
        font-size: 50pt;
        padding: 0px 0.5em;
      }
      .remark-code-line { font-size: 19pt; margin: 0.2em 0px; }
      p { margin: 0.5em 0px; line-height: 120%; }
      code { margin: 0px 2em; }
    </style>
  </head>
  <body>
<textarea id="source">

みなさんこんにちは。

今回のトピックは Mesh を使ったラインの描画です。

---

> Camera

Unity 関係で定期的に受ける質問のひとつに「ラインを描画するにはどうしたらいいのか？」というものがあります。

---

> Editor: Line Renderer Component

Unity には Line Renderer コンポーネントがあります。

単純な１本の線であれば、それを使うのが簡単で便利です。

---

> B-roll: Wireframe

ただ、ワイヤフレームモデルのように大量のラインを引く場合には向いていません。

---

> Camera

そういう場合は、Mesh クラスを使って、Line Mesh を構築して描画する、というのが、最もストレートな実装になります。

---

今回はチュートリアルとして、Mesh クラスを使って大量のラインを描画するというのをやってみましょう。

---

> Demo: Wave

今回作るサンプルはこんな感じです。

ワイヤフレームのメッシュがウネウネとアニメーションする、というのを作ってみます。

---

> Camera

と、その前に、最初はもっと簡単な例から作りましょう。

---

> Demo: Triangle

こんな感じの三角形をラインで描画します。

頂点の座標はそれぞれ (0, 0, 0), (1, 0, 0), (0, 1, 0) になります。

---

> Figure

このようなメッシュを作るには、２つのデータを用意する必要があります。

---

ひとつは頂点配列、 vertex array。

もうひとつは、インデクス配列、 index array です。

---

この場合の vertex array は、既に分かっていますね。

この (0, 0, 0) と (1, 0, 0) と (0, 1, 0) です。

---

> Code

C# コード上で、これを配列にしてから、Mesh に SetVertices を使って設定します。

---

> Figure

次の index array は、これらの頂点をどう結んで線にするのか、という情報です。

配列上のインデクスを順に書いていきます。

---

ここでは、まず０番と１番をラインで結んで、次に１番と２番、最後に２番と０番、というように書いていくことになります。

---

> Code

C# コード上で、これを配列にしてから、Mesh に SetIndices を使って設定します。

---

SetIndices の引数には、index array 以外に、Mesh Topology と Submesh 番号を渡します。

Mesh Topology というのは、このメッシュの構成要素を選ぶものです。

---

今回はラインなので、 Lines を使っています。

普通の、いわゆるポリゴンを使う場合は、ここは Triangles になりますね。

Submesh については、今回は使わない機能なので、常に０を入れておいてください。

---

周辺のコードも整理して書いてみると、こんな感じになります。

Mesh をデフォルトコンストラクタで生成して、vertex と index の設定を行なって、最後に MeshFilter に設定しています。

---

シーン上では空のオブジェクトを作成して、MeshFilter と MeshRenderer と、今書いたスクリプトを追加します。

MeshRenderer のマテリアルには、 Unlit 系のマテリアルを何か設定してください。

これで三角形が描画されるはずです。

---

> Camera

ここまでの基礎ができれば、あとは簡単ですね。

---

> Demo: Wave

頂点を増やして、プログラム上で動きを与えれば、こんな感じのアニメーションが作れるはずです。

---

> Code

さっそくコードを覗いてみましょう。

N はメッシュの細かさを決める定数です。

今回、配列の格納には Generic List クラスを使うことにしました。

バーテクス配列については、毎フレーム更新するので使い回すことにします。

まず最初に組んだのは、バーテクス配列を更新する関数です。

時間を引数 t で受け取ってアニメーションを作ります。

バーテクス配列の順序は、こんな感じにしたいと思います。

横が Column で、縦が Row です。

Row と Column に対応するループがここにありますね。

この中で x-y-z のそれぞれの値を求めているのですが、Mathematics パッケージの中にある math.remap という便利な関数を使っています。

これは、 a から b の間で入力される値を、 c から d の間に remap するという関数です。

ここでは、Row 番号が0から始まって N-1 で終わるので、それを -1 から +1 の範囲に remap することで、このような座標を割り当てているというわけです。

同じことを x でも行なっていますね。

そして、中心から広がる波のアニメーションを作るめに、距離を求めてからサイン波の式に入れています。

最後に SetVertices でバーテクス列の設定ですね。

次に Start の実装です。

メッシュの初期化はさっきと同じですね。

そして、ゼロを引数として先ほどの UpdateVertices を呼び出すことで、バーテクス列の初期化を行なっています。

次はインデクス列の初期化です。

このサンプルではメッシュの基本構造は固定で、インデクス列を更新する必要は無いので、Start の中で初期化だけを行なっています。

まずは横方向のラインの列です。

N 個分の Row を処理するループがあって、ラインの個数は N-1 個になるので、Column のループは N-1 で終わっていますね。

そして隣同士を結ぶインデクスを詰めていくだけです。

次は縦方向のラインの列です。

今度は Row のループが N-1 個になって、Column は N 個分処理します。

隣の列を参照するのに、インデクスを +N するのも、先ほどとの違いですね。

最後に SetIndices して完了です。

あとは Update の際に UpdateVertices を現在時間で実行しています。

</textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        ratio: '16:9',
        highlightStyle: 'sunburst',
        slideNumberFormat: ''
      });
    </script>
  </body>
</html>
